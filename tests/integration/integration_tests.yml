---
- name: CockroachDB Integration Tests
  hosts: cockroachdb_servers
  gather_facts: true
  vars:
    test_db: testdb
    test_user: testuser
    test_pwd: testpassword
    test_table: users
    test_index: idx_users_name
  tasks:
    # Basic connectivity and version check
    - name: Wait for CockroachDB to become available
      ansible.builtin.wait_for:
        port: 26257
        delay: 10
        timeout: 60
      when: not is_ssh_only_container|default(false)
      tags:
        - always
        - cockroachdb_install

    - name: Check CockroachDB version
      ansible.builtin.command: podman exec cockroachdb-install-test cockroach version
      register: cockroach_version
      changed_when: false
      when: not is_ssh_only_container|default(false)
      tags:
        - always
        - cockroachdb_install
      ignore_errors: true

    - name: Debug - show CockroachDB version
      ansible.builtin.debug:
        var: cockroach_version.stdout_lines
      when: cockroach_version is success
      tags:
        - always
        - cockroachdb_install

    # Test installation module specifically
    - name: Check if custom install test container is running
      ansible.builtin.command: podman inspect cockroachdb-install-test
      register: install_container
      failed_when: false
      changed_when: false
      tags:
        - cockroachdb_install

    - name: Set installation test target host
      ansible.builtin.set_fact:
        install_test_host: "{{ (install_container.rc == 0) | ternary('cockroachdb-install-test', 'localhost') }}"
        install_version: "{{ lookup('env', 'CRDB_VERSION') | default('22.2.9', true) }}"
        test_prefix: "cockroachdb_install"
        use_custom_container: true
        test_mode: "{{ lookup('env', 'TEST_MODE') | default('standard', true) }}"
        specific_test: "{{ lookup('env', 'SPECIFIC_TEST') | default('', true) }}"
      tags:
        - cockroachdb_install

    - name: Display installation test environment information
      ansible.builtin.debug:
        msg:
          - "Running installation tests in {{ test_mode }} mode"
          - "CockroachDB version: {{ install_version }}"
          - "Test environment: {{ use_custom_container | ternary('container', 'local host') }}"
          - "Specific test: {{ specific_test | default('all tests') }}"
      tags:
        - cockroachdb_install

    - name: Run installation tests
      ansible.builtin.include_tasks:
        file: "targets/cockroachdb_modules/cockroachdb_install/installation.yml"
      tags:
        - cockroachdb_install

    # Test all CockroachDB modules
    - name: Test cockroachdb_info module
      ansible.builtin.include_tasks:
        file: "targets/cockroachdb_modules/cockroachdb_info/main.yml"
      tags: ["cockroachdb_info"]

    - name: Test cockroachdb_db module
      ansible.builtin.include_tasks:
        file: "targets/cockroachdb_modules/cockroachdb_db/main.yml"
      tags: ["cockroachdb_db"]

    - name: Test cockroachdb_user module
      ansible.builtin.include_tasks:
        file: "targets/cockroachdb_modules/cockroachdb_user/main.yml"
      tags: ["cockroachdb_user"]

    - name: Test cockroachdb_privilege module
      ansible.builtin.include_tasks:
        file: "targets/cockroachdb_modules/cockroachdb_privilege/main.yml"
      tags: ["cockroachdb_privilege"]

    - name: Test cockroachdb_table module
      ansible.builtin.include_tasks:
        file: "targets/cockroachdb_modules/cockroachdb_table/main.yml"
      tags: ["cockroachdb_table"]

    - name: Test cockroachdb_index module
      ansible.builtin.include_tasks:
        file: "targets/cockroachdb_modules/cockroachdb_index/main.yml"
      tags: ["cockroachdb_index"]

    - name: Test cockroachdb_query module
      ansible.builtin.include_tasks:
        file: "targets/cockroachdb_modules/cockroachdb_query/main.yml"
      tags: ["cockroachdb_query"]

    - name: Test cockroachdb_statistics module
      ansible.builtin.include_tasks:
        file: "targets/cockroachdb_modules/cockroachdb_statistics/main.yml"
      tags: ["cockroachdb_statistics"]

    - name: Test cockroachdb_parameter module
      ansible.builtin.include_tasks:
        file: "targets/cockroachdb_modules/cockroachdb_parameter/main.yml"
      tags: ["cockroachdb_parameter"]

    - name: Test cockroachdb_maintenance module
      ansible.builtin.include_tasks:
        file: "targets/cockroachdb_modules/cockroachdb_maintenance/main.yml"
      tags: ["cockroachdb_maintenance"]

    - name: Test cockroachdb_backup module
      ansible.builtin.include_tasks:
        file: "targets/cockroachdb_modules/cockroachdb_backup/main.yml"
      tags: ["cockroachdb_backup"]

    # Cleanup
    # - name: Drop test database
    #   cockroachdb_db:
    #     name: "{{ test_db }}"
    #     state: absent
    #     host: localhost
    #     port: 26257
    #     user: root
    #     ssl_mode: disable

    # - name: Drop test user
    #   cockroachdb_user:
    #     name: "{{ test_user }}"
    #     state: absent
    #     host: localhost
    #     port: 26257
    #     login_user: root
    #     ssl_mode: disable

    # - name: Print test summary
    #   ansible.builtin.debug:
    #     msg: |
    #       CockroachDB Integration Tests Summary:
    #       - Database operations: {{ db_result is changed }}
    #       - User operations: {{ user_result is changed }}
    #       - Privilege operations: {{ priv_result is changed }}
    #       - Table operations: {{ table_result is changed }}
    #       - Index operations: {{ index_result is changed }}
    #       - Query operations: {{ query_result is changed }}
    #       {% if stats_result is defined %}
    #       - Statistics operations: {{ stats_result is changed }}
    #       {% else %}
    #       - Statistics operations: Not tested
    #       {% endif %}
    #       {% if cluster_result is defined %}
    #       - Cluster settings: {{ cluster_result is changed }}
    #       {% else %}
    #       - Cluster settings: Not tested
    #       {% endif %}
    #       {% if param_result is defined %}
    #       - Parameter settings: {{ param_result is changed }}
    #       {% else %}
    #       - Parameter settings: Not tested
    #       {% endif %}
    #       {% if maint_result is defined %}
    #       - Maintenance operations: {{ maint_result is changed }}
    #       {% else %}
    #       - Maintenance operations: Not tested
    #       {% endif %}
    #       {% if backup_result is defined %}
    #       - Backup operations: {{ backup_result is changed }}
    #       {% else %}
    #       - Backup operations: Not tested
    #       {% endif %}
