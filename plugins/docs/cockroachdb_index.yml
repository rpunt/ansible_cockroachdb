---
module: cockroachdb_index
short_description: Manage CockroachDB indexes
description:
  - Create, drop, or manage CockroachDB indexes
options:
  name:
    description:
      - Name of the index to create or remove
    required: true
    type: str
  database:
    description:
      - Database name where the table and index are located
    required: true
    type: str
  table:
    description:
      - Table name where the index should be created or removed
    required: true
    type: str
  state:
    description:
      - The index state
    default: present
    choices: ["present", "absent"]
    type: str
  columns:
    description:
      - List of columns to include in the index
    type: list
    elements: str
    required: false
  expressions:
    description:
      - List of expressions to include in the index
    type: list
    elements: str
    required: false
  unique:
    description:
      - Whether the index should be a unique index
    type: bool
    default: false
  storing:
    description:
      - Columns to store with the index but not index
    type: list
    elements: str
    required: false
  where:
    description:
      - Optional filtering expression for a partial index
    type: str
    required: false
  if_not_exists:
    description:
      - Add IF NOT EXISTS clause to CREATE INDEX
    type: bool
    default: false
  concurrently:
    description:
      - Use CONCURRENTLY option when creating or dropping the index
    type: bool
    default: false
  host:
    description:
      - The CockroachDB database host address
    default: localhost
    type: str
  port:
    description:
      - The CockroachDB database port
    default: 26257
    type: int
  user:
    description:
      - The username to connect to the database
    default: root
    type: str
  password:
    description:
      - The password to connect to the database
    type: str
    required: false
  ssl_mode:
    description:
      - SSL mode for database connection
    type: str
    choices: ["disable", "allow", "prefer", "require", "verify-ca", "verify-full"]
    default: verify-full
  ssl_cert:
    description:
      - Path to client certificate file
    type: str
    required: false
  ssl_key:
    description:
      - Path to client key file
    type: str
    required: false
  ssl_rootcert:
    description:
      - Path to root CA certificate file
    type: str
    required: false
  connect_timeout:
    description:
      - Database connection timeout in seconds
    type: int
    default: 30
requirements:
  - psycopg2
author:
  - "Ryan Punt (@rpunt)"


examples: |
  # Create a basic index
  - name: Create index on users table
    cockroachdb_index:
      name: idx_users_email
      database: production
      table: users
      columns:
        - email
      host: localhost
      port: 26257
      user: root
      ssl_cert: /path/to/client.crt
      ssl_key: /path/to/client.key
      ssl_rootcert: /path/to/ca.crt

  # Create a unique index
  - name: Create unique index on users table
    cockroachdb_index:
      name: idx_users_username
      database: production
      table: users
      columns:
        - username
      unique: true

  # Create a composite index
  - name: Create composite index on orders table
    cockroachdb_index:
      name: idx_orders_customer_date
      database: sales
      table: orders
      columns:
        - customer_id
        - order_date

  # Create a partial index
  - name: Create partial index on orders table for high-value orders
    cockroachdb_index:
      name: idx_high_value_orders
      database: sales
      table: orders
      columns:
        - customer_id
        - order_date
      where: "total_amount > 1000"

  # Create an expression index
  - name: Create expression index for lowercase email
    cockroachdb_index:
      name: idx_users_lower_email
      database: production
      table: users
      expressions:
        - "lower(email)"

  # Drop an index
  - name: Remove index
    cockroachdb_index:
      name: idx_users_email
      database: production
      table: users
      state: absent


return_values:
  index:
    description: Index name that was created or dropped
    returned: always
    type: str
    sample: idx_users_email
  table:
    description: Table name containing the index
    returned: always
    type: str
    sample: users
  database:
    description: Database name containing the table and index
    returned: always
    type: str
    sample: production
  state:
    description: State of the index after task execution
    returned: always
    type: str
    sample: present
  queries:
    description: List of executed SQL queries
    returned: on success
    type: list
    sample: ["CREATE INDEX idx_users_email ON users (email)"]
